#!/bin/bash

#deps: mailx, qpress, xtrabackup

BASEPATH=<%= @backupdest %>
ARCHIVEDIR=<%= @archivedir %>
MAILTO="<%= @mailto %>"

FDATE=$(date +%Y-%m-FULL)
LASTMONTH=$(date --date="$(date +%Y-%m-15) -1 month" "+%Y-%m" )
LASTYEAR=$(date --date="$(date +%Y-%m-15) -1 year" "+%Y" )
DATE=$(date +%Y-%m-%d)
HOST=$(hostname -f)

TMPFILE=$(mktemp /tmp/output.XXXXXXXX.txt)
TIMEFILE=$(mktemp /tmp/timeout.XXXXXXXX.txt)
if [ -e $BASEPATH/$FDATE ]
then
	#We have full backup, create incrementals
	BACKUPTYPE=INCR
	/usr/bin/time -v -o $TIMEFILE innobackupex --compress --safe-slave-backup --rsync --incremental $BASEPATH --incremental-basedir=$BASEPATH/$FDATE > $TMPFILE  2>&1
	RES=$?
else
	#IF there is no FULL backup this month, make one
	BACKUPTYPE=FULL
	/usr/bin/time -v -o $TIMEFILE innobackupex --compress --safe-slave-backup --rsync --no-timestamp $BASEPATH/$FDATE  > $TMPFILE 2>&1
	RES=$?
	#move old backups to ARCHIVEDIR
	mv $BASEPATH/$LASTMONTH* $ARCHIVEDIR
	mv $BASEPATH/$LASTYEAR* $ARCHIVEDIR
fi

ISOK=0

grep 'innobackupex: completed OK' $TMPFILE  > /dev/null || ISOK=1

if [ "$ISOK" == 0 ] && [ "$RES" == 0 ]
then
	BTIME=$(awk '/innobackupex: completed OK/ {print $2}' $TMPFILE )
	SUBJECT="$BACKUPTYPE backup success $HOST $DATE"
	CONTENT="TIME $BTIME"
else
	SUBJECT="$BACKUPTYPE BACKUP FAIL! $HOST $DATE"
	CONTENT="RESULT $RES"
	if [ $BACKUPTYPE == "FULL" ]
	then
		I=1
		while /usr/bin/test -e ${BASEPATH}/${FDATE}.failed.${I}
		do
			I=$(($I+1))
		done
		mv $BASEPATH/$FDATE ${BASEPATH}/${FDATE}.failed.${I}
	fi
fi
<% if @mailfrom.nil? %>
( echo "$SUBJECT" ; echo ; cat $TIMEFILE ) | mailx -s "$SUBJECT" -a $TMPFILE -r root@cashongo.co.uk $MAILTO
<% else %>
( echo "$SUBJECT" ; echo ; cat $TIMEFILE ) | mailx -S "from=<%= @mailfrom %>" -s "$SUBJECT" -a $TMPFILE -r root@cashongo.co.uk $MAILTO
<% end %>

rm $TMPFILE
rm $TIMEFILE
